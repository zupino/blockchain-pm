<html>
<head>
    <meta charset="UTF-8">
    <title>Vanilla Web3 example</title>
	<link rel="stylesheet" type="text/css" href="style.css" >
</head>

<script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

<script>

/* 
 * Variables and constants 
*/

// Full URI of the geth RPC node
// var providerURI = "http://172.18.0.2:8545";
var providerURI = "http://e32058ec.ngrok.io";
//var contractAbiURI = "http://127.0.0.1:8000/Project.json";
var contractAbiURI = "http://bb3b6479.ngrok.io/Project.json";

var contractAbi = "";
const contractAddress = "0x3A40516E3B6bf86326DFb017D90DF66e93Ba2333"
const userAccount = "0xE90055138754e30DC4803218835B8A3019c9fA17";
// this is used to unlock the account
const userPassword = "password2";


/*
 * Retrieve the contract JSON interface and its ABI
*/

$.ajax({
	url: contractAbiURI,
	dataType: 'json',
	async: false,
	success: function(json){
		contractAbi = json.abi;
	},
	error: function() {
		alert("Not possible to retrieve contract JSON interface");
	}
});


/*
 * Connect web3 to provider
*/

var web3 = new Web3(
  new Web3.providers.HttpProvider(
    providerURI,
    {
      headers: [{
        name: 'Access-Control-Allow-Origin',
        value: 'ngrok.io'
      }]
    }
  )
);

// var web3 = new Web3(Web3.givenProvider || providerURI);


/*
 * Unlock user account TBD
*/

/*
 * Check provider connection TBD
*/

web3.eth.defaultAccount = userAccount;

Project = new web3.eth.Contract(contractAbi, contractAddress, {});

// retrieve value of Project budget
Project.methods.getProjectBudgetDrop().call().then( function(result) {
    $('#console').append("<p>Current project budget: " + result + "</p>");
});

</script>
<body>

<div id="content">
    
    <div id="account">
    </div>
    
    <fieldset>
    <legend>Project operations</legend>
    <div id="project-budget">
        <button id="get-project-budget-ether">Get Ether budget</button>
        <button id="get-project-budget-drops">Get Drops budget</button>
    </fieldset>
    
    <fieldset>
    <legend>Task operations</legend>

    <div id="create-new-task">
		<p>Create new task</p>
        <input id="task-title" type="text" value="Hello there">
        <input id="task-id" type="number">
        <button id="add-task" value="Add task">Add</button>
    </div>
    <div id="set-task-workers">
		<p>Assign oracle and assignee</p>
        <input id="set-task-workers-id" value="3" type="number">
        <input id="set-task-assignee-address" value="0xE90055138754e30DC4803218835B8A3019c9fA17">
        <input id="set-task-assignee-compensation" value="3500" type="number">

        <input id="set-task-oracle-address" value="0xE90055138754e30DC4803218835B8A3019c9fA17">
        <input id="set-task-oracle-compensation" value="1500" type="number">
        <button id="set-task-workers">Assign</button>
    </div>

	<div id="start-task">
		<p>Start working on task (both Oracle and Assignee must send deposit)</p>
		<input id="start-task-id" value="3" type="number" >
        <input id="start-task-sender" value="0xE90055138754e30DC4803218835B8A3019c9fA17">
		<button id="start-task">Accept</button>
	</div>

	<div id="resolve-task">
		<p>Resolve Task (Assignee only)</p>
		<input id="resolve-task-id" value="3" type="number" >
		<input id="resolve-task-sender" value="0xE90055138754e30DC4803218835B8A3019c9fA17">
        <button id="resolve-task">Resolve</button>
	</div>

	<div id="close-task">
		<p>Close Task (Oracle only)</p>
        <input id="close-task-id" value="3" type="number" >
        <input id="close-task-sender" value="0xE90055138754e30DC4803218835B8A3019c9fA17">
        <button id="close-task">Resolve</button>
    </div>
	
	</fieldset>

    <div id="add-operators">
    </div>
</div>

<div id="console">
</div>

<script>

// Get project budget Ether
$("#get-project-budget-ether").click( function() {
	Project.methods.getProjectBudgetEther().call().then( function(result) {
    	$('#console').append("<p>Current project budget (test Ether): " + result + "</p>");
	});
});

// Get project budget Drops
$("#get-project-budget-drops").click( function() {
    Project.methods.getProjectBudgetDrop().call().then( function(result) {
        $('#console').append("<p>Current project budget (DRP token): " + result + "</p>");
    });
});

// Add Task
$("#add-task").click( function() {
	Project.methods.addTask($( "#task-title" ).val(), $("#task-id").val() ).send(function(error, transactionHash) {
		$('#console').append("<p>[" + transactionHash + "]</p>");
		$('#console').append("<p>Error: " + error + "</p>");
	});
});

// Set Task workers
$("#set-task-workers").click( function() {
	tid = $("#set-task-workers-id").val();
	assignee = $("#set-task-assignee-address").val();
	oracle = $("#set-task-oracle-address").val();
	aComp = $("#set-task-assignee-compensation").val();
	oComp = $("#set-task-oracle-compensation").val();

	Project.methods.setTaskAssignee( tid, assignee, aComp  ).send(function(error, transactionHash) {
        $('#console').append("<p>[" + transactionHash + "]</p>");
        $('#console').append("<p>Error: " + error + "</p>");
    });

	Project.methods.setTaskAssignee( tid, oracle, oComp  ).send(function(error, transactionHash) {
        $('#console').append("<p>[" + transactionHash + "]</p>");
        $('#console').append("<p>Error: " + error + "</p>");
    });
});

$("#start-task").click( function() {
    tid = $("#start-task-id").val();
	addr = $("#start-task-sender").val();
	Project.methods.startWorkingOnTask(tid).send({from: addr});
});

$("#resolve-task").click( function() {
    tid = $("#resolve-task-id").val();
    addr = $("#resolve-task-sender").val();
    Project.methods.resolveTask(tid).send({from: addr});
});

$("#close-task").click( function() {
    tid = $("#close-task-id").val();
    addr = $("#close-task-sender").val();
    Project.methods.resolveTask(tid).send({from: addr});
});


// Keep console scrolled at the end (not working on Firefox)
$('#console').scrollTop($('#console')[0].scrollHeight);

</script>

</body>
</html>
